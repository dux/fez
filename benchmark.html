<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fez vs React Performance Benchmark</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="./dist/fez.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .benchmark-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 40px;
    }
    .framework-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .framework-section h2 {
      margin-top: 0;
      color: #333;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      font-size: 16px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .winner {
      color: #28a745;
      font-weight: bold;
    }
    .loser {
      color: #dc3545;
    }
    #fez-mount, #react-mount {
      min-height: 100px;
      border: 1px dashed #ddd;
      padding: 10px;
      margin-top: 10px;
    }
    .benchmark-status {
      text-align: center;
      font-size: 18px;
      margin: 20px 0;
      color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .faster {
      color: #28a745;
      font-weight: bold;
    }
    .slower {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Fez vs React Performance Benchmark</h1>
    <p>Comparing rendering performance between Fez and React 18. Generated by Claude.</p>
  </div>

  <div class="controls">
    <button id="runAllBtn">Run All Benchmarks</button>
    <button id="mountBtn">Mount/Unmount Test</button>
    <button id="updateBtn">State Update Test</button>
    <button id="listBtn">List Rendering Test</button>
    <button id="clearBtn">Clear Results</button>
  </div>

  <div class="benchmark-status" id="status">Ready to run benchmarks</div>

  <div class="benchmark-container">
    <div class="framework-section">
      <h2>Fez</h2>
      <div id="fez-mount"></div>
    </div>
    <div class="framework-section">
      <h2>React</h2>
      <div id="react-mount"></div>
    </div>
  </div>

  <div class="results">
    <h2>Results</h2>
    <div id="results-content">
      <p style="text-align: center; color: #666;">Run benchmarks to see results</p>
    </div>
  </div>

  <script>
    // Benchmark utilities
    const benchmark = {
      results: [],

      measure(name, fn, iterations = 1000) {
        const start = performance.now();
        for (let i = 0; i < iterations; i++) {
          fn();
        }
        const end = performance.now();
        return {
          name,
          time: end - start,
          iterations,
          avgTime: (end - start) / iterations
        };
      },

      async measureAsync(name, fn, iterations = 100) {
        const start = performance.now();
        for (let i = 0; i < iterations; i++) {
          await fn();
          // Allow UI to update
          await new Promise(resolve => setTimeout(resolve, 0));
        }
        const end = performance.now();
        return {
          name,
          time: end - start,
          iterations,
          avgTime: (end - start) / iterations
        };
      },

      displayResults(results) {
        const resultsDiv = document.getElementById('results-content');

        const formatTime = (ms) => {
          if (ms < 0.001) {
            return (ms * 1000).toFixed(3) + ' Î¼s';
          } else if (ms < 1) {
            return ms.toFixed(6) + ' ms';
          } else {
            return ms.toFixed(3) + ' ms';
          }
        };

        const getPerformanceDescription = (diff) => {
          const absDiff = Math.abs(diff);
          if (absDiff <= 10) {
            return 'Same performance (within 10%)';
          } else if (absDiff <= 30) {
            return 'Nearly same performance (within 30%)';
          } else {
            return diff > 0 ? 'Fez is faster' : 'React is faster';
          }
        };

        resultsDiv.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Test</th>
                <th>Fez (avg)</th>
                <th>React (avg)</th>
                <th>Fez Total</th>
                <th>React Total</th>
                <th>Difference</th>
                <th>Winner</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              ${results.map(result => {
                const diff = ((result.react - result.fez) / result.react * 100).toFixed(2);
                const fezFaster = result.fez < result.react;
                const description = getPerformanceDescription(parseFloat(diff));
                return `
                  <tr>
                    <td>${result.test}</td>
                    <td class="${fezFaster ? 'faster' : 'slower'}">${formatTime(result.fez)}</td>
                    <td class="${!fezFaster ? 'faster' : 'slower'}">${formatTime(result.react)}</td>
                    <td class="${fezFaster ? 'faster' : 'slower'}">${formatTime(result.fezTotal)}</td>
                    <td class="${!fezFaster ? 'faster' : 'slower'}">${formatTime(result.reactTotal)}</td>
                    <td>${fezFaster ? '+' : ''}${diff}%</td>
                    <td class="${fezFaster ? 'faster' : 'slower'}">${fezFaster ? 'Fez' : 'React'}</td>
                    <td>${description}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      },

      addResult(testResult) {
        // Find and replace existing result for the same test, or add new one
        const existingIndex = this.results.findIndex(r => r.test === testResult.test);
        if (existingIndex >= 0) {
          this.results[existingIndex] = testResult;
        } else {
          this.results.push(testResult);
        }
        this.displayResults(this.results);
      }
    };

    // Status updates
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    // Button handlers
    document.getElementById('clearBtn').addEventListener('click', () => {
      benchmark.results = [];
      document.getElementById('results-content').innerHTML = '<p style="text-align: center; color: #666;">Run benchmarks to see results</p>';
      document.getElementById('fez-mount').innerHTML = '';
      document.getElementById('react-mount').innerHTML = '';
      updateStatus('Results cleared');
    });

    document.getElementById('runAllBtn').addEventListener('click', async () => {
      updateStatus('Running all benchmarks...');
      benchmark.results = [];

      await runMountUnmountBenchmark();
      await new Promise(resolve => setTimeout(resolve, 500));

      await runStateUpdateBenchmark();
      await new Promise(resolve => setTimeout(resolve, 500));

      await runListRenderingBenchmark();

      updateStatus('All benchmarks complete!');
    });

    document.getElementById('mountBtn').addEventListener('click', runMountUnmountBenchmark);
    document.getElementById('updateBtn').addEventListener('click', runStateUpdateBenchmark);
    document.getElementById('listBtn').addEventListener('click', runListRenderingBenchmark);

    // Define Fez components
    Fez('fez-counter', class {
      HTML = `<div>Count: {{ state.count }}</div>`
      init() {
        this.state.count = 0
      }
      increment() {
        this.state.count++;
      }
    });

    Fez('fez-list', class {
      HTML = `
        <div>
          {{raw state.items.map(item => '<span>' + item + '</span>').join('') }}
        </div>
      `
      init() {
        this.state.items = []
      }
      setItems(items) {
        this.state.items = items;
      }
    });

    // Define React components
    const ReactCounter = () => {
      const [count, setCount] = React.useState(0);
      React.useImperativeHandle(ReactCounter.ref, () => ({
        increment: () => setCount(c => c + 1)
      }), []);
      return React.createElement('div', null, `Count: ${count}`);
    };
    ReactCounter.ref = React.createRef();

    const ReactList = () => {
      const [items, setItems] = React.useState([]);
      React.useImperativeHandle(ReactList.ref, () => ({
        setItems: (newItems) => setItems(newItems)
      }), []);
      return React.createElement('div', null,
        items.map((item, i) => React.createElement('span', { key: i }, item))
      );
    };
    ReactList.ref = React.createRef();

    // Mount/Unmount benchmark
    async function runMountUnmountBenchmark() {
      updateStatus('Running mount/unmount benchmark...');

      const fezMount = document.getElementById('fez-mount');
      const reactMount = document.getElementById('react-mount');
      const iterations = 100;

      // Fez mount/unmount
      const fezResult = await benchmark.measureAsync('Fez Mount/Unmount', () => {
        const el = document.createElement('fez-counter');
        fezMount.appendChild(el);
        fezMount.removeChild(fezMount.firstChild);
      }, iterations);

      // React mount/unmount
      let reactRoot = ReactDOM.createRoot(reactMount);
      const reactResult = await benchmark.measureAsync('React Mount/Unmount', () => {
        reactRoot.render(React.createElement(ReactCounter));
        reactRoot.unmount();
        reactRoot = ReactDOM.createRoot(reactMount);
      }, iterations);

      benchmark.addResult({
        test: 'Mount/Unmount',
        fez: fezResult.avgTime,
        react: reactResult.avgTime,
        fezTotal: fezResult.time,
        reactTotal: reactResult.time,
        iterations: iterations
      });
      updateStatus('Mount/unmount benchmark complete');
    }

    // State update benchmark
    async function runStateUpdateBenchmark() {
      updateStatus('Running state update benchmark...');

      const fezMount = document.getElementById('fez-mount');
      const reactMount = document.getElementById('react-mount');

      // Clear mounts
      fezMount.innerHTML = '';
      reactMount.innerHTML = '';

      // Mount Fez component
      const fezCounter = document.createElement('fez-counter');
      fezMount.appendChild(fezCounter);
      await new Promise(resolve => setTimeout(resolve, 100)); // Let it initialize

      // Get the replaced element with fez instance
      const fezInstance = fezMount.querySelector('.fez-fez-counter');

      // Mount React component
      const reactRoot = ReactDOM.createRoot(reactMount);
      const CounterWithRef = React.forwardRef((props, ref) => {
        const [count, setCount] = React.useState(0);
        React.useImperativeHandle(ref, () => ({
          increment: () => setCount(c => c + 1)
        }), []);
        return React.createElement('div', null, `Count: ${count}`);
      });

      const reactRef = React.createRef();
      reactRoot.render(React.createElement(CounterWithRef, { ref: reactRef }));
      await new Promise(resolve => setTimeout(resolve, 100)); // Let it initialize

      const iterations = 1_000_000;

      // Fez state updates
      const fezResult = benchmark.measure('Fez State Update', () => {
        fezInstance.fez.increment();
      }, iterations);

      // React state updates
      const reactResult = benchmark.measure('React State Update', () => {
        reactRef.current.increment();
      }, iterations);

      benchmark.addResult({
        test: 'State Update',
        fez: fezResult.avgTime,
        react: reactResult.avgTime,
        fezTotal: fezResult.time,
        reactTotal: reactResult.time,
        iterations: iterations
      });
      updateStatus('State update benchmark complete');
    }

    // List rendering benchmark
    async function runListRenderingBenchmark() {
      updateStatus('Running list rendering benchmark...');

      const fezMount = document.getElementById('fez-mount');
      const reactMount = document.getElementById('react-mount');

      // Clear mounts
      fezMount.innerHTML = '';
      reactMount.innerHTML = '';

      // Mount components
      const fezList = document.createElement('fez-list');
      fezMount.appendChild(fezList);
      await new Promise(resolve => setTimeout(resolve, 100));

      // Get the replaced element with fez instance
      const fezListInstance = fezMount.querySelector('.fez-fez-list');

      const reactRoot = ReactDOM.createRoot(reactMount);
      const ListWithRef = React.forwardRef((props, ref) => {
        const [items, setItems] = React.useState([]);
        React.useImperativeHandle(ref, () => ({
          setItems: (newItems) => setItems(newItems)
        }), []);
        return React.createElement('div', null,
          items.map((item, i) => React.createElement('span', { key: i }, item))
        );
      });

      const reactRef = React.createRef();
      reactRoot.render(React.createElement(ListWithRef, { ref: reactRef }));
      await new Promise(resolve => setTimeout(resolve, 100));

      // Test with different list sizes
      const sizes = [10, 100, 1000];

      for (const size of sizes) {
        const items = Array(size).fill(0).map((_, i) => `Item ${i}`);

        // Measure time until DOM is actually updated
        const measureRenderTime = async (name, updateFn) => {
          const times = [];

          for (let i = 0; i < 20; i++) {
            const start = performance.now();
            updateFn();

            // Wait for next animation frame to ensure render is complete
            await new Promise(resolve => requestAnimationFrame(() => {
              requestAnimationFrame(resolve);
            }));

            const end = performance.now();
            times.push(end - start);

            // Clear the list between tests
            updateFn([]);
            await new Promise(resolve => setTimeout(resolve, 10));
          }

          const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
          const totalTime = times.reduce((a, b) => a + b, 0);

          return { avgTime, time: totalTime, iterations: times.length };
        };

        // Fez list rendering
        const fezResult = await measureRenderTime(`Fez List ${size}`,
          (items = Array(size).fill(0).map((_, i) => `Item ${i}`)) => {
            fezListInstance.fez.setItems(items);
          }
        );

        // React list rendering
        const reactResult = await measureRenderTime(`React List ${size}`,
          (items = Array(size).fill(0).map((_, i) => `Item ${i}`)) => {
            reactRef.current.setItems(items);
          }
        );

        benchmark.addResult({
          test: `List Render (${size} items)`,
          fez: fezResult.avgTime,
          react: reactResult.avgTime,
          fezTotal: fezResult.time,
          reactTotal: reactResult.time,
          iterations: 20
        });
      }

      updateStatus('List rendering benchmark complete');
    }
  </script>
</body>
</html>
